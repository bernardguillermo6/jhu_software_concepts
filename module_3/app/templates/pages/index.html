{% extends "base.html" %}

{% block title %}Answers{% endblock %}

{% block content %}
<h1>Answers</h1>

<!-- Buttons Row -->
<div class="button-row">
    <!-- Fetch New Data Button -->
    <form id="fetch-form" action="{{ url_for('pages.scrape') }}" method="post">
        <button type="submit" id="fetch-btn" class="btn"
            title="Pull in the most up to date information from thegradcafe.com"
            {% if is_scraping %}disabled{% endif %}>
            Pull Data
        </button>
    </form>

    <!-- Refresh SQL Queries Button -->
    <form id="refresh-form" action="{{ url_for('pages.refresh_queries') }}" method="post">
        <button type="submit" id="refresh-btn" class="btn"
            title="Update the answers to include the most up to date data"
            {% if is_scraping %}disabled{% endif %}>
            Update Analysis
        </button>
    </form>
</div>

<hr>

{% for row in data %}
<div class="qa">
    <div class="question"><strong>Q:</strong> {{ row.question }}</div>
    <div class="answer"><strong>A:</strong> {{ row.answer }}</div>
</div>
{% endfor %}

<script>
function setButtonsDisabled(disabled) {
    const fetchBtn = document.getElementById("fetch-btn");
    const refreshBtn = document.getElementById("refresh-btn");
    fetchBtn.disabled = disabled;
    refreshBtn.disabled = disabled;
    fetchBtn.style.opacity = disabled ? 0.5 : 1;
    refreshBtn.style.opacity = disabled ? 0.5 : 1;
    fetchBtn.style.cursor = disabled ? "not-allowed" : "pointer";
    refreshBtn.style.cursor = disabled ? "not-allowed" : "pointer";
}

// Poll server to re-enable buttons when scraper is finished
function checkScraperStatus() {
    fetch('{{ url_for("pages.scraper_status") }}')
        .then(response => response.json())
        .then(data => setButtonsDisabled(data.is_scraping));
}

// Immediately disable buttons when fetch form is submitted
document.getElementById("fetch-form").addEventListener("submit", function() {
    setButtonsDisabled(true);
});

// Poll every 3 seconds
setInterval(checkScraperStatus, 3000);
</script>
{% endblock %}
